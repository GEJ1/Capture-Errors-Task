<!DOCTYPE html>
<html>
    <head>
        <script src="jspsych/jspsych.js"></script>
        <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
        <link href="jspsych/css/jspsych.css" rel="stylesheet">
        <script src="jspsych/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych/plugins/jspsych-fullscreen.js"></script>


        <!-- <script src="timer.js"></script> -->
        <link rel="stylesheet" href="timer_css.css"></link>
    </head>

    <body></body>

    <script>

        // Timer function copied from:
        // https://stackoverflow.com/questions/20618355/the-simplest-possible-javascript-countdown-timer
        // function startTimer(duration, display) {
        //     var start = Date.now(),
        //         diff,
        //         minutes,
        //         seconds;
        //     function timer() {
        //         // get the number of seconds that have elapsed since 
        //         // startTimer() was called
        //         diff = duration - (((Date.now() - start) / 1000) | 0);

        //         // does the same job as parseInt truncates the float
        //         minutes = (diff / 60) | 0;
        //         seconds = (diff % 60) | 0;

        //         minutes = minutes < 10 ? "0" + minutes : minutes;
        //         seconds = seconds < 10 ? "0" + seconds : seconds;
        //         display = document.querySelector('#time');
        //         if (display !== null) {
        //             display.innerHTML = minutes + ":" + seconds;
        //         }

        //        // display.textContent = minutes + ":" + seconds; 
               

        //         if (diff <= 0) {
        //             // add one second so that the count down starts at the full duration
        //             // example 05:00 not 04:59
        //             start = Date.now() + 1000;
        //      }
        //     };
        //     // we don't want to wait a full second before the timer starts
        //     timer();
        //     setInterval(timer, 1000);
        // }

        function setUpEvents(){

                const FULL_DASH_ARRAY = 283;
                const WARNING_THRESHOLD = 10;
                const ALERT_THRESHOLD = 5;
                // timer_clock = document.querySelector(".base-timer");

                const COLOR_CODES = {
                info: {
                    color: "green"
                },
                warning: {
                    color: "orange",
                    threshold: WARNING_THRESHOLD
                },
                alert: {
                    color: "red",
                    threshold: ALERT_THRESHOLD
                }
                };

                const TIME_LIMIT = 20;
                let timePassed = 0;
                let timeLeft = TIME_LIMIT;
                let timerInterval = null;
                let remainingPathColor = COLOR_CODES.info.color;


                document.getElementById("app").innerHTML = `
                <div class="base-timer">
                <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g class="base-timer__circle">
                    <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
                    <path
                        id="base-timer-path-remaining"
                        stroke-dasharray="283"
                        class="base-timer__path-remaining ${remainingPathColor}"
                        d="
                        M 50, 50
                        m -45, 0
                        a 45,45 0 1,0 90,0
                        a 45,45 0 1,0 -90,0
                        "
                    ></path>
                    </g>
                </svg>
                <span id="base-timer-label" class="base-timer__label">${formatTime(
                    timeLeft
                )}</span>
                </div>
                `;

                startTimer();

                function onTimesUp() {
                clearInterval(timerInterval);
                }

                function startTimer() {
                timerInterval = setInterval(() => {
                    timePassed = timePassed += 1;
                    timeLeft = TIME_LIMIT - timePassed;
                    document.getElementById("base-timer-label").innerHTML = formatTime(
                    timeLeft
                    );
                    setCircleDasharray();
                    setRemainingPathColor(timeLeft);

                    // if (timeLeft === 15) {
                    
                    //   timer_clock.style.display = "none";
                    // }
                    if (timeLeft === 0) {
                    // timer_clock.style.display = "visible";
                    onTimesUp();
                    }
                }, 1000);
                }

                function formatTime(time) {
                const minutes = Math.floor(time / 60);
                let seconds = time % 60;

                if (seconds < 10) {
                    seconds = `0${seconds}`;
                }

                return `${minutes}:${seconds}`;
                }

                function setRemainingPathColor(timeLeft) {
                const { alert, warning, info } = COLOR_CODES;
                if (timeLeft <= alert.threshold) {
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.remove(warning.color);
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.add(alert.color);
                } else if (timeLeft <= warning.threshold) {
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.remove(info.color);
                    document
                    .getElementById("base-timer-path-remaining")
                    .classList.add(warning.color);
                }
                }

                function calculateTimeFraction() {
                const rawTimeFraction = timeLeft / TIME_LIMIT;
                return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
                }

                function setCircleDasharray() {
                const circleDasharray = `${(
                    calculateTimeFraction() * FULL_DASH_ARRAY
                ).toFixed(0)} 283`;
                document
                    .getElementById("base-timer-path-remaining")
                    .setAttribute("stroke-dasharray", circleDasharray);
                }
                }

        var timeline = [];

        /* define rotate trial */
        var rotate = {
        type: "html-button-response",
        stimulus: '<p>Por favor habilite la opcion de rotacion de pantalla y gire su telefono.</p><br><IMG vertical-align: middle; SRC="img/rotate.gif">',
        // prompt: '',
        choices: ['Continuar'],
        };
        // timeline.push(rotate);

        //Full screen
        var fullScreen = {
            type: 'fullscreen',
            fullscreen_mode: true,
            message: '<p>El experimento ira a pantalla completa cuando usted presione el boton que se encuentra debajo</p><br>',
            button_label: 'Continuar a pantalla completa'    
        } 

        var start_screen = {
            type: 'html-keyboard-response',
            stimulus: 'So it begins.'
        }
        // timeline.push(start_screen)

        var stopwatch = {
            on_load:  function() {
                setUpEvents()
                
                },
            type: 'html-button-response',
            stimulus: '<div  id="app"></div>',
            choices: ['A', 'B'],
            button_html:`<button style="font-size:30px; class="jspsych-btn">%choice%</button>`,
      
             margin_horizontal: '36px'
        }
        // timeline.push(stopwatch)

        jsPsych.init({
            timeline: [stopwatch,stopwatch],
            on_finish: function(){
                jsPsych.data.displayData();
            }
        })

    </script>


</html>