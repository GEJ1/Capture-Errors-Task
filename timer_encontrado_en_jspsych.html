<!DOCTYPE html>
<html>
    <head>
        <script src="jspsych/jspsych.js"></script>
        <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
        <link href="jspsych/css/jspsych.css" rel="stylesheet">
        <script src="jspsych/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych/plugins/jspsych-instructions_modified.js"></script> 


        <!-- <script src="timer.js"></script> -->
        <link rel="stylesheet" href="timer_css.css"></link>
    </head>

    <body></body>

    <script>

        let timerInterval;
        const TIME_LIMIT = 10;
        let timeline = [];


        function setUpEvents(){
                const FULL_DASH_ARRAY = 283;
                const WARNING_THRESHOLD = TIME_LIMIT/2;
                const ALERT_THRESHOLD = TIME_LIMIT/3;

                const COLOR_CODES = {
                    info: {
                        color: "green"
                    },
                    warning: {
                        color: "orange",
                        threshold: WARNING_THRESHOLD
                    },
                    alert: {
                        color: "red",
                        threshold: ALERT_THRESHOLD
                    }
                };

                
                let timePassed = 0;
                let timeLeft = TIME_LIMIT;
                let remainingPathColor = COLOR_CODES.info.color;


                document.getElementById("app").innerHTML = `
                <div class="base-timer">

                <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g class="base-timer__circle">
                    <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
                    <path
                        id="base-timer-path-remaining"
                        stroke-dasharray="283"
                        class="base-timer__path-remaining ${remainingPathColor}"
                        d="
                        M 50, 50
                        m -45, 0
                        a 45,45 0 1,0 90,0
                        a 45,45 0 1,0 -90,0
                        "
                    ></path>
                    </g>
                </svg>
                <span id="base-timer-label" class="base-timer__label">${formatTime(timeLeft)}</span>
                </div>
                `;

                startTimer();

                function onTimesUp() {
                    clearInterval(timerInterval);
                    console.log('onTimesUp')
                    
                    // Aca tiene que ir algo para pasar de trial
                }

                function startTimer() {

                    timerInterval = setInterval(() => {
                        let end_trial = 0;
                        timePassed = timePassed += 1;
                        timeLeft = TIME_LIMIT - timePassed;
                        document.getElementById("base-timer-label").innerHTML = formatTime(timeLeft);
                        setCircleDasharray();
                        setRemainingPathColor(timeLeft);
                        console.log(timeLeft)
                        if (timeLeft === 0) {
                            console.log('if')
                            onTimesUp();
                        }
                    }, 1000);
                    
                }

                function formatTime(time) {
                    const minutes = Math.floor(time / 60);
                    let seconds = time % 60;

                    return `${minutes}:${seconds}`;
                }

                function setRemainingPathColor(timeLeft) {
                    const { alert, warning, info } = COLOR_CODES;
                    if (timeLeft <= alert.threshold) {
                        document.getElementById("base-timer-path-remaining").classList.remove(warning.color);
                        document.getElementById("base-timer-path-remaining").classList.add(alert.color);
                    } else if (timeLeft <= warning.threshold) {
                        document.getElementById("base-timer-path-remaining").classList.remove(info.color);
                        document.getElementById("base-timer-path-remaining").classList.add(warning.color);
                    }
                }

                function calculateTimeFraction() {
                    const rawTimeFraction = timeLeft / TIME_LIMIT;
                    return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
                    }

                function setCircleDasharray() {
                    const circleDasharray = `${(calculateTimeFraction() * FULL_DASH_ARRAY).toFixed(0)} 283`;
                    document.getElementById("base-timer-path-remaining").setAttribute("stroke-dasharray", circleDasharray);
                    }
                }
        

        // Rotate trial 
        let rotate = {
            on_load:  rotation = function() {
                window.addEventListener("orientationchange", function(event) {
                    if (event.target.screen.orientation.angle){
                        jsPsych.finishTrial();
                        window.removeEventListener("orientationchange", rotation)
                    }
                }
            )}, 
            type: "html-button-response",
            stimulus: '<p>Por favor habilite la opcion de rotacion de pantalla y gire su telefono para continuar </p><br><IMG vertical-align: middle; SRC="img/rotate.gif">',
            choices: ['Continuar']
        };


        // Full screen trial
        var fullScreen = {
            type: 'fullscreen',
            fullscreen_mode: true,
            message: '<p>El experimento ira a pantalla completa cuando usted presione el boton que se encuentra debajo</p><br>',
            button_label: 'Continuar a pantalla completa'    
        } 

        // Instructions trial
        var instructions = {
            type: 'instructions',
            pages: [
                    ` 
                    <p style='font-size:150%;color:black'>  Instrucciones p치gina 1.<br>` ,

                    `<p style='font-size:150%;color:black'>  Instrucciones p치gina 2.<br>`,

                    `<p style='font-size:150%;color:black'>  Instrucciones p치gina 3.<br>`
                    ],

            show_clickable_nav: true,
            show_page_number: true,
            button_label_previous: 'Anterior',
            button_label_next: 'Siguiente',
            page_label: 'P치gina'
        }

        var fixation = {
            type: 'html-keyboard-response',
            stimulus: '<div style="font-size:60px;">+</div>',
            // stimulus: '<div style="font-size:60px;">+</div>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            data: {test_part: 'fixation'}
            }

        var stopwatch = {
            on_load:  function() {
                setUpEvents()
                
            },
            type: 'html-button-response',
            stimulus: '<center><strong><P style="font-size:60px;" >ABC</P></strong><div id="app"></div></center>',
            choices: ['ABC','BCA'],
            
            button_html:`<button style="font-size:30px; class="jspsych-btn">%choice%</button>`,
            margin_horizontal: '20px',
            margin_vertical: '16px',
            trial_duration: TIME_LIMIT*1000,
            on_finish: function(startTimer) {
                clearInterval(timerInterval)
            }
        }


        // let procedure = {
        //     timeline: [fixation,stopwatch],
        //     timeline_variables: [
        //         {choices: function(){
        //             ['ABC', 'CBA']}
        //         },
        //         {choices: ['XXX', 'YYY']} 
        //     ]
        // }

        jsPsych.init({
            timeline: [fixation,stopwatch,fixation,stopwatch],
            // timeline: [fullScreen,rotate,instructions,fixation,stopwatch,fixation,stopwatch],
            // timeline: [stopwatch,stopwatch,stopwatch],
            on_finish: function(){

                jsPsych.data.displayData();
                //Go to URL
                // location.href = "https://gej1.github.io/"
            }
        })

    </script>


</html>