<!DOCTYPE html>
<html>
    <head>
        <script src="jspsych/jspsych.js"></script>
        <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
        <link href="jspsych/css/jspsych.css" rel="stylesheet">
        <script src="jspsych/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych/plugins/jspsych-instructions_modified.js"></script> 
        <script src="jspsych/plugins/jspsych-survey-html-form.js"></script> 

        


        <!-- <script src="timer.js"></script> -->
        <link rel="stylesheet" href="timer.css"></link>
    </head>

    <body></body>

    <script>

// ID
let subject_id = jsPsych.randomization.randomID(10);

// SAVE dimensions
jsPsych.data.addProperties({'ID': subject_id})
jsPsych.data.addProperties({'screenX': screen.width});
jsPsych.data.addProperties({'screenY': screen.height});
jsPsych.data.addProperties({'innerX': window.innerWidth});
jsPsych.data.addProperties({'innerY': window.innerHeight});

let timerInterval;
        const TIME_LIMIT = 4;
        let timeline = [];

        function setUpEvents(){
                const FULL_DASH_ARRAY = 283;
                const WARNING_THRESHOLD = TIME_LIMIT/2;
                const ALERT_THRESHOLD = TIME_LIMIT/3;

                const COLOR_CODES = {
                    info: {
                        color: "green"
                    },
                    warning: {
                        color: "orange",
                        threshold: WARNING_THRESHOLD
                    },
                    alert: {
                        color: "red",
                        threshold: ALERT_THRESHOLD
                    }
                };

                
                let timePassed = 0;
                let timeLeft = TIME_LIMIT;
                let remainingPathColor = COLOR_CODES.info.color;


                document.getElementById("app").innerHTML = `
                <div class="base-timer">

                <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g class="base-timer__circle">
                    <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
                    <path
                        id="base-timer-path-remaining"
                        stroke-dasharray="283"
                        class="base-timer__path-remaining ${remainingPathColor}"
                        d="
                        M 50, 50
                        m -45, 0
                        a 45,45 0 1,0 90,0
                        a 45,45 0 1,0 -90,0
                        "
                    ></path>
                    </g>
                </svg>
                <span id="base-timer-label" class="base-timer__label">${formatTime(timeLeft)}</span>
                </div>
                `;

                startTimer();

                function onTimesUp() {
                    clearInterval(timerInterval);
                    console.log('onTimesUp')
                }

                function startTimer() {

                    timerInterval = setInterval(() => {
                        let end_trial = 0;
                        timePassed = timePassed += 1;
                        // console.log(timePassed)
                        timeLeft = TIME_LIMIT - timePassed;
                        document.getElementById("base-timer-label").innerHTML = formatTime(timeLeft);
                        setCircleDasharray();
                        setRemainingPathColor(timeLeft);
                        console.log(timeLeft)
                        if (timeLeft === 0) {
                            console.log('if')
                            onTimesUp();
                        }
                    }, 1000);
                    
                }

                function formatTime(time) {
                    const minutes = Math.floor(time / 60);
                    let seconds = time % 60;

                    return `${minutes}:${seconds}`;
                }

                function setRemainingPathColor(timeLeft) {
                    const { alert, warning, info } = COLOR_CODES;
                    if (timeLeft <= alert.threshold) {
                        document.getElementById("base-timer-path-remaining").classList.remove(warning.color);
                        document.getElementById("base-timer-path-remaining").classList.add(alert.color);
                    } else if (timeLeft <= warning.threshold) {
                        document.getElementById("base-timer-path-remaining").classList.remove(info.color);
                        document.getElementById("base-timer-path-remaining").classList.add(warning.color);
                    }
                }

                function calculateTimeFraction() {
                    const rawTimeFraction = timeLeft / TIME_LIMIT;
                    return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
                    }

                function setCircleDasharray() {
                    const circleDasharray = `${(calculateTimeFraction() * FULL_DASH_ARRAY).toFixed(0)} 283`;
                    document.getElementById("base-timer-path-remaining").setAttribute("stroke-dasharray", circleDasharray);
                    }
                }

        // Rotate trial 
            let rotate = {
            on_load: function() {
                let orientationHandler = function(){
                    if (event.target.screen.orientation.angle){
                        window.removeEventListener("orientationchange", orientationHandler)
                        jsPsych.finishTrial();  
                    }
                } 
                window.addEventListener("orientationchange", orientationHandler)},

            type: "html-button-response",
            stimulus: '<p>Por favor habilite la opcion de rotacion de pantalla y gire su telefono para continuar </p><br><IMG vertical-align: middle; SRC="img/rotate.gif">',
            choices: ['Continuar'] // [] in final version. No button needed, only rotated device. 
        };

        // Full screen trial
        var fullScreen = {
            type: 'fullscreen',
            fullscreen_mode: true,
            message: '<p>El experimento ira a pantalla completa cuando usted presione el boton que se encuentra debajo</p><br>',
            button_label: 'Continuar a pantalla completa'    
        } 

    // Welcome
    var welcome_block = {
            data: {
                screen_id: "Bienvenidx"
            },
            type: "survey-html-form",
            preamble: "<p>¡Te damos la bienvenida al experimento!</p>" + "Por favor, completa los siguientes datos: </p> </p> ",
            html: 
                `<table>
                    <tr>
                    <td align="right">Edad:</td>
                    <td align="left"><input name="age" type="number" required="" /></td>
                    </tr>
                    <tr>
                    <td align="right">Género:</td>
                    <td align="left"><input list="gender" id="gender-choice" name="gender-choice" required="" /><datalist id="gender"> 
                    <option value="MASCULINO"> <option value="FEMENINO"> <option value="OTRO"></datalist></td>
                    </tr>
                    <tr>
                    <td align="right">Máximo nivel educativo alcanzado:</td>
                    <td align="left"><input list="education" id="education-choice" name="education-choice" required="" /><datalist id="education"> 
                    <option value="Primario"> <option value="Secundario"> <option value="Terciario no universitario"><option value="Universitario"> <option value="Posgrado"></datalist></td>
                    </tr>

                </table>`,

                button_label: "Continuar"
                };

        // Instructions trials
        var instructions_1 = {
            type: 'instructions',
            pages: [
                    ` 
                    <p style='font-size:100%;color:black'>  Les damos la bienvenida al experimento. [Agregar explicación general de las tareas].<br>` ,

                    `<p style='font-size:100%;color:black'>  A CONTINUACIÓN, VAS A ENCONTRAR UNA SERIE DE NÚMEROS. 
                    Presiona la opción que sea igual al modelo. Por ejemplo, si el modelo es <strong> 1 3 </strong> la opción correcta sería <strong>1 3</strong>. 
                    En algunas ocasiones las dos opciones pueden ser correctas, cuando ese sea el caso, selecciona cualquiera de los estímulos. 
                    En la pantalla habrá también un círculo que mostrará el tiempo que tienes disponible para dar tu respuesta.`
                    ],
            show_clickable_nav: true,
            show_page_number: true,
            button_label_previous: 'Anterior',
            button_label_next: 'Siguiente',
            page_label: 'Página'
        }

        var instructions_2 = {
            type: 'instructions',
            pages: [
                    `<p style='font-size:100%;color:black'>  A CONTINUACIÓN, VAS A ENCONTRAR UNA SERIE DE NÚMEROS. 
                    Presiona la opción que marque el orden inverso al modelo. Por ejemplo, si el modelo es <strong> 5 7 </strong> 
                    la opción correcta sería <strong> 7 5</strong>. 
                    Los mismos números, pero de atrás hacia adelante. Nuevamente, en algunas ocasiones las dos opciones pueden ser correctas, 
                    cuando ese sea el caso, 
                    selecciona cualquiera de los estímulos. En la pantalla habrá también un círculo que mostrará el tiempo que tienes 
                    disponible para dar tu respuesta.>`
                    ],
            show_clickable_nav: true,
            show_page_number: true,
            button_label_previous: 'Anterior',
            button_label_next: 'Siguiente',
            page_label: 'Página'
        }

            // Stimuli to be presented. This can be automated based on a stimuli list.
            var stimuli_task_1 = [
            { stimulus: "<center><strong><P style='font-size:30px; margin: 3px;'> 21 </P></strong><div id='app'></div></center>", 
            choices: ['12', '21'], data: {test_part: 'test', correct_response: '1'}},
            { stimulus: "<center><strong><P style='font-size:30px; margin: 3px;'> 77 </P></strong><div id='app'></div></center>", choices: ['77', '77'],
            data: {test_part: 'test', correct_response: 'equal'}} // Ver como poner el correcto cuando los dos lo sean
            ];

            var stimuli_task_2 = [
            { stimulus: "<center><strong><P style='font-size:30px; margin: 3px;'> 91 </P></strong><div id='app'></div></center>", 
            choices: ['91', '19'], data: {test_part: 'test', correct_response: '1'}},
            { stimulus: "<center><strong><P style='font-size:30px; margin: 3px;'> 11 </P></strong><div id='app'></div></center>", choices: ['11', '11'],
            data: {test_part: 'test', correct_response: 'equal'}} // Ver como poner el correcto cuando los dos lo sean
            ];

        // task trials
        var task_1 = {
            on_load:  function() {
                setUpEvents()
                
            },
            type: 'html-button-response',
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: jsPsych.timelineVariable('choices'),
            
            button_html:`<button style="font-size:30px; class="jspsych-btn">%choice%</button>`,
            margin_horizontal: '20px',
            margin_vertical: '16px',
            trial_duration: TIME_LIMIT*1000,
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data) { // This function previosly receives startTimer, maybe doesn't work well now
                clearInterval(timerInterval)
                if (data.correct_response == 'equal'){ //This is the case for equal digits, e.g. 7 7.
                    data.correct = true
                } else{
                    data.correct = data.button_pressed == data.correct_response;
                }
                console.log(data.correct)

            }
        }

        var task_2 = {
            on_load:  function() {
                setUpEvents()
                
            },
            type: 'html-button-response',
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: jsPsych.timelineVariable('choices'),
            
            button_html:`<button style="font-size:30px; class="jspsych-btn">%choice%</button>`,
            margin_horizontal: '20px',
            margin_vertical: '16px',
            trial_duration: TIME_LIMIT*1000,
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data) { // This function previosly receives startTimer, maybe doesn't work well now
                clearInterval(timerInterval)
                if (data.correct_response == 'equal'){
                    data.correct = true
                } else{
                    data.correct = data.button_pressed == data.correct_response;
                    
                }
                console.log(data.correct)
                
                
            }
        }

        // procedures
        var test_procedure_1 = {
            timeline: [task_1],
            timeline_variables: stimuli_task_1
            }

        var test_procedure_2 = {
            timeline: [task_2],
            timeline_variables: stimuli_task_2
            }

            var debrief_block = {
                type: "html-button-response",
                stimulus: function() {

                    var trials = jsPsych.data.get().filter({test_part: 'test'});
                    var correct_trials = trials.filter({correct: true});
                    var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
                    var rt = Math.round(trials.select('rt').mean()); //change this if you want only time of correct
                    

                    // Separar en distintos globos de colores.
                    return "<div style = 'background-color: green; border-radius: 15px 50px; padding: 20px;' ><p style='color:white;text-align:center;'>Respondiste correctamente en el  "+accuracy+"% de los ensayos.</p>"+
                    "<p style='color:white;text-align:center;'>Tu tiempo de respuesta promedio fue de "+rt+" milisegundos.</p>"+
                    "<p style='color:white;text-align:center;'> Muchas gracias!</p> </div>"

                    },
            
                choices: ['Enviar datos y terminar']
                };

        jsPsych.init({

            timeline: [welcome_block,fullScreen,rotate,instructions_1,test_procedure_1,instructions_2,test_procedure_2,debrief_block],
            // timeline: [fullScreen,test_procedure_1,debrief_block],
            
            show_progress_bar: true,
            message_progress_bar: 'Porcentaje completado',
            on_finish: function(){
                jsPsych.data.displayData();
                //Go to URL
                // location.href = "https://gej1.github.io/"
            }
        })

    </script>


</html>